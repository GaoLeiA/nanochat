<mxfile host="app.diagrams.net">
  <diagram name="训练流程序列图" id="training_sequence">
    <mxGraphModel dx="1400" dy="900" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1400" pageHeight="1000">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>
        
        <!-- 标题 -->
        <mxCell id="title" value="NanoChat 训练流程序列图" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=20;fontStyle=1;fontColor=#333333;" parent="1" vertex="1">
          <mxGeometry x="450" y="10" width="300" height="30" as="geometry"/>
        </mxCell>
        
        <!-- 参与者 -->
        <mxCell id="user" value="用户" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;fillColor=#dae8fc;strokeColor=#6c8ebf;size=40;" parent="1" vertex="1">
          <mxGeometry x="40" y="50" width="80" height="900" as="geometry"/>
        </mxCell>
        
        <mxCell id="base_train" value="base_train.py" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;fillColor=#fff2cc;strokeColor=#d6b656;size=40;" parent="1" vertex="1">
          <mxGeometry x="160" y="50" width="100" height="900" as="geometry"/>
        </mxCell>
        
        <mxCell id="gpt_model" value="GPT模型" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;fillColor=#d5e8d4;strokeColor=#82b366;size=40;" parent="1" vertex="1">
          <mxGeometry x="300" y="50" width="80" height="900" as="geometry"/>
        </mxCell>
        
        <mxCell id="dataloader" value="DataLoader" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;fillColor=#e1d5e7;strokeColor=#9673a6;size=40;" parent="1" vertex="1">
          <mxGeometry x="420" y="50" width="80" height="900" as="geometry"/>
        </mxCell>
        
        <mxCell id="tokenizer" value="Tokenizer" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;fillColor=#f8cecc;strokeColor=#b85450;size=40;" parent="1" vertex="1">
          <mxGeometry x="540" y="50" width="80" height="900" as="geometry"/>
        </mxCell>
        
        <mxCell id="optimizer" value="MuonAdamW" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;fillColor=#ffe6cc;strokeColor=#d79b00;size=40;" parent="1" vertex="1">
          <mxGeometry x="660" y="50" width="90" height="900" as="geometry"/>
        </mxCell>
        
        <mxCell id="ckpt_mgr" value="Checkpoint&#xa;Manager" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;fillColor=#f5f5f5;strokeColor=#666666;size=40;" parent="1" vertex="1">
          <mxGeometry x="790" y="50" width="90" height="900" as="geometry"/>
        </mxCell>
        
        <mxCell id="evaluator" value="Evaluator" style="shape=umlLifeline;perimeter=lifelinePerimeter;whiteSpace=wrap;html=1;container=1;collapsible=0;recursiveResize=0;outlineConnect=0;fillColor=#dae8fc;strokeColor=#6c8ebf;size=40;" parent="1" vertex="1">
          <mxGeometry x="920" y="50" width="80" height="900" as="geometry"/>
        </mxCell>
        
        <!-- 消息流 -->
        <!-- 1. 初始化阶段 -->
        <mxCell id="msg1" value="1. torchrun base_train" style="endArrow=block;style=html=1;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="80" y="110" as="sourcePoint"/>
            <mxPoint x="210" y="110" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="msg2" value="2. get_tokenizer()" style="endArrow=block;style=html=1;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="210" y="140" as="sourcePoint"/>
            <mxPoint x="580" y="140" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="msg2r" value="返回 tokenizer" style="endArrow=block;style=html=1;strokeWidth=2;dashed=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="580" y="160" as="sourcePoint"/>
            <mxPoint x="210" y="160" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="msg3" value="3. 创建GPT(config)" style="endArrow=block;style=html=1;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="210" y="190" as="sourcePoint"/>
            <mxPoint x="340" y="190" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="msg4" value="4. init_weights()" style="endArrow=block;style=html=1;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="210" y="220" as="sourcePoint"/>
            <mxPoint x="340" y="220" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="msg5" value="5. torch.compile(model)" style="endArrow=block;style=html=1;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="210" y="250" as="sourcePoint"/>
            <mxPoint x="340" y="250" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="msg6" value="6. 创建优化器" style="endArrow=block;style=html=1;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="210" y="280" as="sourcePoint"/>
            <mxPoint x="705" y="280" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="msg7" value="7. 创建DataLoader" style="endArrow=block;style=html=1;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="210" y="310" as="sourcePoint"/>
            <mxPoint x="460" y="310" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <!-- 训练循环 -->
        <mxCell id="loop_box" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#000000;strokeWidth=2;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="50" y="350" width="960" height="400" as="geometry"/>
        </mxCell>
        <mxCell id="loop_label" value="loop [训练迭代]" style="text;html=1;strokeColor=none;fillColor=#e1d5e7;align=left;verticalAlign=middle;fontSize=12;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="55" y="350" width="120" height="25" as="geometry"/>
        </mxCell>
        
        <mxCell id="msg8" value="8. next(train_loader)" style="endArrow=block;style=html=1;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="210" y="400" as="sourcePoint"/>
            <mxPoint x="460" y="400" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="msg8a" value="encode(batch)" style="endArrow=block;style=html=1;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="460" y="420" as="sourcePoint"/>
            <mxPoint x="580" y="420" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="msg8r" value="返回 (inputs, targets)" style="endArrow=block;style=html=1;strokeWidth=2;dashed=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="460" y="450" as="sourcePoint"/>
            <mxPoint x="210" y="450" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="msg9" value="9. forward(x, y) → loss" style="endArrow=block;style=html=1;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="210" y="490" as="sourcePoint"/>
            <mxPoint x="340" y="490" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="msg10" value="10. loss.backward()" style="endArrow=block;style=html=1;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="210" y="530" as="sourcePoint"/>
            <mxPoint x="340" y="530" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="msg11" value="11. optimizer.step()" style="endArrow=block;style=html=1;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="210" y="570" as="sourcePoint"/>
            <mxPoint x="705" y="570" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <!-- 评估阶段 -->
        <mxCell id="opt_box" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#82b366;strokeWidth=2;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="150" y="610" width="850" height="80" as="geometry"/>
        </mxCell>
        <mxCell id="opt_label" value="opt [每N步评估]" style="text;html=1;strokeColor=none;fillColor=#d5e8d4;align=left;verticalAlign=middle;fontSize=11;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="155" y="610" width="100" height="20" as="geometry"/>
        </mxCell>
        
        <mxCell id="msg12" value="12. evaluate_core()" style="endArrow=block;style=html=1;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="210" y="650" as="sourcePoint"/>
            <mxPoint x="960" y="650" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="msg12r" value="返回 CORE score" style="endArrow=block;style=html=1;strokeWidth=2;dashed=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="960" y="670" as="sourcePoint"/>
            <mxPoint x="210" y="670" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <!-- 保存阶段 -->
        <mxCell id="opt_box2" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#d79b00;strokeWidth=2;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="150" y="700" width="720" height="40" as="geometry"/>
        </mxCell>
        <mxCell id="opt_label2" value="opt [每N步保存]" style="text;html=1;strokeColor=none;fillColor=#ffe6cc;align=left;verticalAlign=middle;fontSize=11;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="155" y="700" width="100" height="20" as="geometry"/>
        </mxCell>
        
        <mxCell id="msg13" value="13. save_checkpoint()" style="endArrow=block;style=html=1;strokeWidth=2;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="210" y="725" as="sourcePoint"/>
            <mxPoint x="835" y="725" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <!-- 结束 -->
        <mxCell id="msg14" value="14. 训练完成" style="endArrow=block;style=html=1;strokeWidth=2;dashed=1;" parent="1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="210" y="800" as="sourcePoint"/>
            <mxPoint x="80" y="800" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
